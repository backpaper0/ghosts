<!DOCTYPE html>
<html>
  <head>
    <title>Domaå®Ÿè·µ</title>
    <meta charset="utf-8">
    <style>
@import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);
@font-face {
    font-family: 'mplus';
    src: url('assets/mplus-1c-regular.ttf');
}
h1, h2, h3, h4, h5, h6 {
    font-family: 'mplus';
}
p, li {
    font-family: 'mplus';
    font-size: 1.5em;
}
code.remark-inline-code {
    font-family: 'Ubuntu Mono';
}
code.remark-code {
    font-family: 'Ubuntu Mono';
    font-size: 1.2em;
}
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Domaå®Ÿè·µ

---

## ã‚¢ã‚¸ã‚§ãƒ³ãƒ€

* `Dao`ã‚’CDIç®¡ç†ã™ã‚‹
* `EntityListener`ã‚’CDIç®¡ç†ã™ã‚‹
* JAX-RSã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ä½¿ã†
* JAX-RSã¨JSONã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
* ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã¨æ›–æ˜§ãªçŠ¶æ…‹
* Domaã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
* Domaã¸ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã™ã‚‹

---

class: center, middle

## `Dao`ã‚’CDIç®¡ç†ã™ã‚‹

---

### CDIã§ç®¡ç†ã™ã‚‹å¯¾è±¡

* `Config` ( `DataSource` , `Dialect` )
* `Dao`

ä»¥ä¸‹ã¯ç®¡ç†ã—ãªã„

* ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹

---

### ã‚„ã‚ŠãŸã„ã“ã¨

```java
@ApplicationScoped
public class AccountService {
    //â†“Daoã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸã„
    @Inject AccountDao dao;

    ...çœç•¥...
}
```

---

### ã‚„ã‚‰ãªãã¦ã¯ã„ã‘ãªã„ã“ã¨

* `Config`å®Ÿè£…ã‚¯ãƒ©ã‚¹ãƒ» `Dao`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã«ã‚¹ã‚³ãƒ¼ãƒ—ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹
  (CDIç®¡ç†ã™ã‚‹ãŸã‚ã®æ¡ä»¶)
* `Dao`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã® `Config` ã‚’å—ã‘å–ã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã« `@Inject` ã‚’ä»˜ã‘ã‚‹
  (CDIç®¡ç†ã•ã‚Œã¦ã„ã‚‹ `Config` ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹)

---

### `Config`å®Ÿè£…ã‚¯ãƒ©ã‚¹

```java
@ApplicationScoped
public class MyConfig implements Config {
    @Resource(name = "java:comp/env/jdbc/myDS")
    private DataSource dataSource;
    private Dialect dialect = new OracleDialect();
    public DataSource getDataSource() { return dataSource; }
    public Dialect getDialect() { return dialect; }
}
```

`@Resource`ã§`DataSource`ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ã¦ã„ã‚‹ã€‚

---

### `Dao`å®Ÿè£…ã‚¯ãƒ©ã‚¹

* `Dao`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã¯æ³¨é‡ˆå‡¦ç†ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹
* ã‚¹ã‚³ãƒ¼ãƒ—ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã«ã¯æ³¨é‡ˆå‡¦ç†ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦

---

### `@AnnotateWith` ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†

* ãã®ã‚‚ã®ã‚ºãƒãƒªã€`Dao`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã«ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ä»•çµ„ã¿

```java
@Dao
@AnnotateWith(annotations = {
    @Annotation(target = AnnotationTarget.CLASS,
                  type = ApplicationScoped.class),
    @Annotation(target = AnnotationTarget.CONSTRUCTOR,
                  type = Inject.class) })
public interface AccountDao { ... }
```

---

### ç”Ÿæˆã•ã‚Œã‚‹ `Dao` å®Ÿè£…ã‚¯ãƒ©ã‚¹

```java
@ApplicationScoped
public class AccountDaoImpl extends AbstractDao
                            implements AccountDao {
    ...

    @Inject
    public AccountDaoImpl(Config config) {
        super(config);
    }

    ...
}
```

â€»è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚FQCNã‚’å˜ç´”åã«ã—ãŸã‚Šæ”¹è¡Œã—ãŸã‚Šã—ã¦ã„ã¾ã™

---

### ã§ã‚‚â€¦â€¦

å…¨éƒ¨ã®`Dao`ã«ã“ã‚“ãªã«ã‚‚ã‚Šã‚‚ã‚Šã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ›¸ã„ã¦ã„ã‚‰ã‚Œãªã„ã€‚

---

### ãã“ã§

`@AnnotateWith`ã‚’ä»˜ã‘ãŸã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨æ„ã—ã¦ã€

```java
@AnnotateWith(annotations = {
    @Annotation(target = AnnotationTarget.CLASS,
                  type = ApplicationScoped.class),
    @Annotation(target = AnnotationTarget.CONSTRUCTOR,
                  type = Inject.class) })
@Retention(RetentionPolicy.RUNTIME)
public @interface CdiManaged {
}
```

---

### ãã‚Œã‚’

`Dao`ã«ä»˜ã‘ã¦ã‚‚åŒã˜åŠ¹æœã‚’å¾—ã‚‰ã‚Œã‚‹ã€‚

```java
@Dao
@CdiManaged
public interface AccountDao { ... }
```

ã™ã£ãã‚Šã€‚

---

### `Dao`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã®ãŠã™ã™ã‚ã‚¹ã‚³ãƒ¼ãƒ—

* `@ApplicationScoped` ãŒãŠã™ã™ã‚
* ã‚‚ã—ãã¯ `@Dependent`
* `@RequestScoped` ã¯Webã«ã—ã‹ä½¿ãˆãªã„ã‹ã‚‰é¿ã‘ãŸã„
* `@SessionScoped` ã¯è«–å¤–

---

### `Dao`ã‚’ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ã™ã‚‹ã“ã¨ã®æ˜¯é

* `Dao`ã‚’ä½¿ã†å´ã®ã‚³ãƒ¼ãƒ‰ã§`new`ã™ã‚‹å¿…è¦ãŒãªããªã£ã¦ã‚³ãƒ¼ãƒ‰ãŒæ¸›ã‚‹
* `Dao`ã«ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã‚’é©ç”¨ã§ãã‚‹
* `Dao`ä»¥å¤–ã®ã‚³ãƒ³ãƒ†ãƒŠç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¨çµ±ä¸€æ„ŸãŒå‡ºã›ã‚‹

ã¶ã£ã¡ã‚ƒã‘ãã“ã¾ã§ãŸã„ã—ãŸãƒ¡ãƒªãƒƒãƒˆã§ã¯ãªã„ã®ã§ç„¡ç†ã«DIã‚³ãƒ³ãƒ†ãƒŠä½¿ã‚ãªãã¦ã‚‚è‰¯ã„ã‘ã©ç§ã¯ä½¿ã†ã®ã§æ¬¡ã‚‚CDIã®è©±é¡Œã§ã™ã€‚

---

class: center, middle

## `EntityListener`ã‚’CDIç®¡ç†ã™ã‚‹

---

### `EntityListener`ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã•ã‚Œã‚‹å ´æ‰€

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`EntityListener`ã¯`EntityListenerProvider`ã«ã‚ˆã£ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚Œã‚‹ã€‚

---

### `EntityListenerProvider`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå®Ÿè£…

`EntityListenerProvider.get`ã§ã¯æ¸¡ã•ã‚ŒãŸ`Supplier`ã®`get`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã„ã‚‹ã ã‘ã€‚

```java
public interface EntityListenerProvider {

    default <E, L extends EntityListener<E>> L get(
            Class<L> listenerClass,
            Supplier<L> listenerSupplier) {

        return listenerSupplier.get();
    }
}
```

---

### æ¸¡ã•ã‚Œã‚‹`Supplier`ã«ã¤ã„ã¦

* `Supplier`ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ³¨é‡ˆå‡¦ç†ã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã‚¯ãƒ©ã‚¹ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦`EntityListenerProvider.get`ã«æ¸¡ã—ã¦ã„ã‚‹
* ã“ã®`Supplier`ã¯`EntityListener`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’å˜ç´”ã«`new`ã—ã¦ã„ã‚‹

â€»è©³ç´°ã¯ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚
ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã‚¯ãƒ©ã‚¹ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨åŒã˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åã®å…ˆé ­ã«ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’ä»˜ã‘ãŸåå‰ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

---

### ã“ã“ã¾ã§ãŠã•ã‚‰ã„

* `EntityListener`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯`EntityListenerProvider.get`ã§å–å¾—ã•ã‚Œã‚‹
* `EntityListenerProvider.get`ã§ã¯`Supplier.get`ã§å¾—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ã‚‹
* `Supplier.get`ã§ã¯å˜ç´”ã«`new`ã•ã‚Œã¦ã„ã‚‹

ãªãŠã€`EntityListenerProvider`ã¯`Config`ã‹ã‚‰å–å¾—ã•ã‚Œã‚‹

---

### `EntityListener`ã‚’CDIç®¡ç†ã™ã‚‹æ–¹æ³•

* CDIç®¡ç†ã•ã‚ŒãŸ`EntityListener`ã‚’ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹`EntityListenerProvider.get`ã‚’å®Ÿè£…
* ãã®`EntityListenerProvider`å®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’`Config.getEntityListenerProvider` ã‹ã‚‰è¿”ã™ã‚ˆã†ã«ã™ã‚‹

---

### `EntityListenerProvider`ã®å®Ÿè£…ä¾‹

å¼•æ•°ã®`listenerClass`ã¨`CDI`ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚

```java
public class CdiEntityListenerProvider
        implements EntityListenerProvider {

    public <E, L extends EntityListener<E>>
            L get(Class<L> listenerClass,
                  Supplier<L> listenerSupplier) {
        return CDI.current().select(listenerClass).get();
    }
}
```

---

### `Config.getEntityListenerProvider`

```java
public class MyConfig implements Config {

    ...

    public EntityListenerProvider getEntityListenerProvider() {
        return new CdiEntityListenerProvider();
    }
}
```

ã‚‚ã¡ã‚ã‚“`CdiEntityListenerProvider`è‡ªä½“ã‚’CDIç®¡ç†ã—ã¦ã‚‚OK(ã‚ã‚“ã¾ã‚Šæ„å‘³ãªã•ãã†ã ã‘ã©)

---

### ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¨ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—

* ä»Šå›ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºç›¤ãƒ»å…±é€šéƒ¨å“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã®ã§ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½¿ç”¨ã—ãŸã‘ã©å€‹åˆ¥ã®æ©Ÿèƒ½ã§ã¯ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã¹ã
* ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚ˆã‚Šã‚‚ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
* jQueryã‚ˆã‚Šã‚‚MVVMã€ã¨ã„ã†æ§‹å›³ã«ä¼¼ã¦ã„ã‚‹
* ã“ã®è¾ºã®ç†ç”±ã‚’ã†ã¾ãè¨€èªåŒ–ã§ããšæ„Ÿè¦šã§è©±ã—ã¦ã„ã‚‹ã®ã§ä»Šåº¦ã¯DIã‚’ãƒ†ãƒ¼ãƒã«ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã—ã¾ã—ã‚‡ã†

---

### ã¡ãªã¿ã« `EntityListenerProvider` ã¯

![doma-practice-01](assets/doma-practice-01.png)

![doma-practice-02](assets/doma-practice-02.png)

ç§ãŒå®Ÿè£…ã—ã¾ã—ãŸ(ãƒ‰ãƒ¤é¡”

---

class: center, middle

## JAX-RSã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ä½¿ã†

---

### JAX-RSã§ã¯

ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚„ãƒ•ã‚©ãƒ¼ãƒ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã€ãƒ‘ã‚¹ã®ä¸€éƒ¨ãªã©ã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã§å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```java
@Path("accounts/{id}")
@POST
@Consumes("application/x-www-form-urlencoded")
public void get(
        @PathParam("id") String id,
        @QueryParam("email") String email) {
    ...
}
```

ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«`String`ã§ã¯ãªããƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã„ãŸã„ã€‚

---

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ã™ã‚‹ã«ã¯

æ¬¡ã®ã„ãšã‚Œã‹ã‚’ä½œã‚Œã°è‰¯ã„ã€‚

* `String`ã‚’å—ã‘å–ã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
* `String`ã‚’å—ã‘å–ã‚‹`valueOf`ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
* `String`ã‚’å—ã‘å–ã‚‹`fromString`ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
* `ParamConverter`å®Ÿè£…ã‚¯ãƒ©ã‚¹

---

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ä½¿ãˆã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã®ä¾‹

```java
@Domain(valueType = String.class)
public class EmailAddress {
    private final String value;
    public EmailAddress(String value) { this.value = value; }
    public String getValue() { return value; }
}
```

ã‚ã£ã•ã‚Šã§ããŸã€‚

---

### `valueType`ãŒ`String.class`ä»¥å¤–ã®ä¾‹

```java
@Domain(valueType = Long.class)
public class Key {
    private final Long value;
    public Key(Long value) { this.value = value; }
    public Long getValue() { return value; }

    public static Key valueOf(String value) {
        return new Key(Long.valueOf(value));
    }
}
```

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ã¯åˆ¥ã«ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã™ã‚Œã°è‰¯ã„ã€‚

---

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ãŸä¾‹

```java
@Path("accounts/{id}")
@POST
@Consumes("application/x-www-form-urlencoded")
public void get(
        @PathParam("id") Key id,
        @QueryParam("email") EmailAddress email) {
    ...
}
```

---

class: center, middle

## JAX-RSã¨JSONã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹

---

### å‰æ

* GlassFish(Payara)

---

### ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å«ã‚€POJOã‚’JSONã§è¿”ã™

ã“ã†ã„ã†POJOã‹ã‚‰ã€

```java
public class Account {
    public Username username;
    public EmailAddress email;
}
```

ã“ã†ã„ã†JSONã‚’ä½œã‚ŠãŸã„ã€‚

```json
{"username":"ã†ã‚‰ãŒã¿","email":"backpaper0@gmail.com"}
```

---

### ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’JSONã«æ›¸ãå‡ºã™ã«ã¯

`XmlAdapter`ã‚’æ›¸ã‘ã°OKã€‚

```java
public class MailAddressXmlAdapter
        extends XmlAdapter<String, MailAddress> {

    public MailAddress unmarshal(String v) throws Exception {
        return v != null ? new MailAddress(v) : null;
    }

    public String marshal(MailAddress v) throws Exception {
        return v != null ? v.getValue() : null;
    }
}
```

---

### JSONãªã®ã«`XmlAdapter`ï¼Ÿï¼Ÿï¼Ÿ

* GlassFishãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®JSONå¤‰æ›ã¯JAXBçµŒç”±ã§è¡Œã‚ã‚Œã‚‹
* Jacksonã‚’ä½¿ã†å ´åˆã‚‚`XmlAdapter`ã«ã‚ˆã‚‹å¤‰æ›ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹

ãã‚“ãªã‚ã‘ã§`XmlAdapter`ãŒãŠæ‰‹è»½ã§ã™ã€‚

---

### `XmlAdapter`ã‚’é©ç”¨ã™ã‚‹

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«`@XmlJavaTypeAdapter`ã‚’ä»˜ã‘ã¦`XmlAdapter`ã‚’æŒ‡å®šã™ã‚‹ã‹ã€

```java
public class Account {
    public String username;
    @XmlJavaTypeAdapter(MailAddressXmlAdapter.class)
    public MailAddress email;
}
```

---

### `XmlAdapter`ã‚’é©ç”¨ã™ã‚‹

POJOãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®`package-info.java`ã«`@XmlJavaTypeAdapter`ã‚’ä»˜ã‘ã¦`XmlAdapter`ã‚’æŒ‡å®šã™ã‚‹ã‹ã€

```java
@XmlJavaTypeAdapter(MailAddressXmlAdapter.class)
package app.entity;
```

---

### `XmlAdapter`ã‚’é©ç”¨ã™ã‚‹

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã«`@XmlJavaTypeAdapter`ã‚’ä»˜ã‘ã¦`XmlAdapter`ã‚’æŒ‡å®šã™ã‚‹ã€‚

```java
@XmlJavaTypeAdapter(MailAddressXmlAdapter.class)
@Domain(valueType = String.class)
public class MailAddress {
    ...
```

---

### `XmlAdapter`ã‚’é©ç”¨ã™ã‚‹

* ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«`@XmlJavaTypeAdapter`
* `package-info.java`ã«`@XmlJavaTypeAdapter`
* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã«`@XmlJavaTypeAdapter`

å€‹äººçš„ã«ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã«`@XmlJavaTypeAdapter`ã‚’ä»˜ã‘ã‚‹ã®ãŒãŠã™ã™ã‚ã€‚

---

### ã¨ã“ã‚ã§

`XmlAdapter`ã®å®Ÿè£…ã¯åŸºæœ¬çš„ã«ã¯`unmarshal`ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ç”Ÿæˆã€`marshal`ã§å€¤ã‚’å–ã‚Šå‡ºã™ã¨ã„ã†ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆãªã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã€‚

---

### ã¨ã„ã†ã‚ã‘ã§

ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‹ã‚‰`XmlAdapter`ã‚’ç”Ÿæˆã™ã‚‹æ³¨é‡ˆãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’æœ€è¿‘æ›¸ã„ã¦ã„ã¾ã™ã€‚

![doma-practice-09](assets/doma-practice-09.png)

---

class: center, middle

## ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹

---

### ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã®æ´»ç”¨

* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã¯å‹å¼•æ•°ã‚’å–ã‚‹ã“ã¨ãŒã§ãã‚‹

```java
@Domain(valueType = Long.class)
public class Key<ENTITY> {
    private final Long value;
    public Key(Long value) { this.value = value; }
    public Long getValue() { return value; }
}
```

å‹å¼•æ•°ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹å†…ã§ã¯ã¾ã£ãŸãä½¿ç”¨ã•ã‚Œãªã„ãŒâ€¦â€¦

---

### `Dao` ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã§å½¹ç«‹ã¤ 

```java
@Select
Account selectById(Key<Account> id);
```

* ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã›ã‚‹ã®ã¯ `Key<Account>` ã ã‘
* `Key<Task>` ã‚„ `Key<Project>` ã®ã‚ˆã†ã«ç•°ãªã‚‹å‹å¼•æ•°ã‚’å–ã‚‹ `Key` ã‚’æ¸¡ãã†ã¨ã™ã‚‹ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹

![doma-practice-03](assets/doma-practice-03.png)

---

### ã‚¸ã‚§ãƒãƒªãƒƒã‚¯ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã‚ãªã„ã¨

```java
@Select
Account selectById(Key id);
```

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã§æ¤œå‡ºã§ããªã„

![doma-practice-04](assets/doma-practice-04.png)

---

class: center, middle

## ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹

---

### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã®æ´»ç”¨

* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚‚ã§ãã‚‹
* ãã®å ´åˆã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒä½¿ãˆãªã„ã®ã§staticãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨æ„ã™ã‚‹

```java
@Domain(valueType = String.class,
        factoryMethod = "valueOf")
public interface Color {

    String getValue();

    static Color valueOf(String value) {
        return new ColorImpl(value);
    }
}
```

---

### ä½¿ã„ã©ã“ã‚

æ±ºã¾ã£ãŸå€¤ãŒã‚ã‚‹ã‘ã©è‡ªç”±å…¥åŠ›ã‚‚è¨±ã™ã¨ã„ã†å ´åˆã«ä¾¿åˆ©

```java
//å®šç¾©æ¸ˆã¿ã®è‰²ã‚’è¡¨ç¾ã™ã‚‹
public enum DefinedColor implements Color {
    RED, BLUE, GREEN;
    public String getValue() { return name(); }
}

//#f90c76 ã®ã‚ˆã†ãª16é€²æ•°è¡¨ç¾ã‚’ã™ã‚‹
public class ColorImpl implements Color {
    private final String value;
    public ColorImpl(String value) { this.value = value; }
    public String getValue() { return value; }
}
```

---

### `Color.valueOf`ã®å®Ÿè£…ä¾‹

```java
static Color valueOf(String value) {
    //å®šç¾©æ¸ˆã¿ã®è‰²ãŒã‚ã‚Œã°DefinedColorã‚’è¿”ã™
    //ãªã‘ã‚Œã°ColorImplã‚’è¿”ã™
    return Arrays.stream(DefinedColor.values())
            .filter(c -> value.equals(c.getValue()))
            .findFirst()
            .map(Color.class::cast)
            .orElseGet(() -> new ColorImpl(value));
}
```

---

### ã¡ãªã¿ã«

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã¯staticãªãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§Java 8ã§ãªã„ã¨å®Ÿç¾ã§ããªã„ã‘ã©ã€
å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ãˆã°ä¼¼ãŸã‚ˆã†ãªäº‹ã¯å‡ºæ¥ã‚‹ã®ã§Java 8ã‚ˆã‚Šå‰ã‚’å¼·ã„ã‚‰ã‚Œã¦ã„ã¦ã‚‚å®‰å¿ƒï¼

---

### ã¡ãªã¿ã«(2)

![doma-practice-05](assets/doma-practice-05.png)

ã“ã‚Œã‚‚ç§ãŒå®Ÿè£…ã—ã¾ã—ãŸ(ãƒ‰ãƒ¤é¡”

---

class: center, middle

## ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã¨æ›–æ˜§ãªçŠ¶æ…‹

---

### å‰æ–¹ä¸€è‡´ã®æ¤œç´¢æ¡ä»¶ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã§æ‰±ã†

* ç”»é¢ã§å…¥åŠ›ã•ã‚ŒãŸå€¤ã‚’ã‚‚ã¨ã«å‰æ–¹ä¸€è‡´æ¤œç´¢ã‚’è¡Œã†
* æ¥­å‹™ã‚¢ãƒ—ãƒªã§ã‚ˆãã‚ã‚‹æ„Ÿã˜ã®ä»•æ§˜

---

### ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’æ™®é€šã«ä½¿ã†ã¨

æ›–æ˜§ãªçŠ¶æ…‹ã‚’è¨±å®¹ã—ãªãã¦ã¯ã„ã‘ãªã„

![doma-practice-06](assets/doma-practice-06.png)

```java
//å‰æ–¹ä¸€è‡´ã®æ¤œç´¢æ¡ä»¶ãªã®ã§backpaper0@gmail.comã§ã¯ãªã
//backpapã¿ãŸã„ãªæ›–æ˜§ãªçŠ¶æ…‹ã‚’è¨±å®¹ã›ã–ã‚‹ã‚’ãˆãªã„
@GET
public Response search(
    @QueryParam("email") EmailAddress condition) { ... }
```

---

### åˆ¶ç´„ã‚’å®ˆã‚‹

* ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã¯åˆ¶ç´„ã‚’å®ˆã£ã¦ä½¿ã†ã¹ã
* æ›–æ˜§ãªçŠ¶æ…‹ã‚’è¨±ã™ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†å ´é¢ã§ä¸å®‰ã«ãªã‚‹

---

### ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã‚ãªã„ã¨

å‹ã‚’ `String` ãªã©ã®åŸºæœ¬å‹ã«ã™ã‚‹ã¨å‹ã‹ã‚‰ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã®ã‹ãã‚Œä»¥å¤–ã®é …ç›®ãªã®ã‹ãŒåˆ†ã‹ã‚‰ãªããªã‚‹

```java
@GET
public Response search(
    @QueryParam("email") String condition) { ... }
```

â€»å‹ã¯å¤§åˆ‡ã«ã—ã¾ã—ã‚‡ã†

---

### ãã“ã§â€¦â€¦

å‰æ–¹ä¸€è‡´ã®æ¤œç´¢æ¡ä»¶ã‚’è¡¨ã™ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å°å…¥ã—ã¦ã¿ã‚‹

```java
@Domain(valueType = String.class)
public class PartOf<T> {
    private final String value;
    public PartOf(String value) { this.value = value; }
    public String getValue() { return value; }
}
```

ã“ã®ã‚ˆã†ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ä½œã£ã¦â€¦â€¦

---

### å‰æ–¹ä¸€è‡´æ¡ä»¶ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹

ã“ã†ä½¿ã†

```java
@GET
public Response search(
    @QueryParam("email") PartOf<EmailAddress> condition) {
        ...
}
```

å‹å¤‰æ•°ã«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã§ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸€éƒ¨ã€ã¨ã„ã†ã“ã¨ã‚’å‹ã§è¡¨ç¾

---

class: center, middle

## Domaã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

---

### `Config`

ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‚

* `Config.getQueryImplementors`
* `Config.getCommandImplementors`

---

### `Dao`ãƒ¡ã‚½ãƒƒãƒ‰ã¯

* ã‚¯ã‚¨ãƒªã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦
* ã‚¯ã‚¨ãƒªã‚’çµ„ã¿ç«‹ã¦ã¦
* ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦
* ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

ã¨ã„ã£ãŸå‡¦ç†ã‚’è¡Œã†ã€‚

---

### ã“ã®å‡¦ç†ã®ä¸­ã§

ã‚¯ã‚¨ãƒªã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã«`QueryImplementers`ã‚’ã€ã‚³ãƒãƒ³ãƒ‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã«`CommandImplementers`ã‚’ä½¿ã†ã®ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã‚¯ã‚¨ãƒªã‚„ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹ã€‚

---

### `QueryImplementers`ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

è‰²ã€…è©¦ã™æ™‚é–“ãŒå–ã‚Œãšçœç•¥ğŸ˜¨ğŸ’¦(ã”ã‚ã‚“ãªã•ã„)

SQLæ–‡ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ASTã‚’æ§‹ç¯‰ã™ã‚‹å‡¦ç†ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã®ã§ã€ä¾‹ãˆã°è‡ªå‹•çš„ã«`å‰Šé™¤ãƒ•ãƒ©ã‚° = false`ã‚’ä»˜ã‘ãŸã‚¯ã‚¨ãƒªã«å¤‰æ›ã™ã‚‹ã€ãªã©ãŒã§ãã‚‹ã€‚ã¨æ€ã†(è‰¯ã„ä¾‹ã§ã¯ãªã„)

---

### `CommandImplementers`ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ã‚³ãƒãƒ³ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ãªã“ã¨ã‚’è¡Œã†ã€‚

* `PreparedStatement`ã‚’å®Ÿè¡Œ
* (æ¤œç´¢ç³»ã‚³ãƒãƒ³ãƒ‰ãªã‚‰)çµæœã‚’ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãªã©ã¸ãƒãƒƒãƒ”ãƒ³ã‚°

---

### `CommandImplementers`ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

ä¾‹ãˆã°ã€

* ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ–­æ™‚ã«ãƒªãƒˆãƒ©ã‚¤ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
* æ¤œç´¢ç³»ã¯ã‚¹ãƒ¬ãƒ¼ãƒ–ã€æ›´æ–°ç³»ã¯ãƒã‚¹ã‚¿ãƒ¼ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
* ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãªã©ã®ã‚¯ãƒ­ãƒ¼ã‚ºã‚’é…å»¶ã•ã›ã¦`Dao`ãƒ¡ã‚½ãƒƒãƒ‰ã®å¤–éƒ¨ã§`Stream`ã‚„`Iterator`ã‚’ä½¿ã†ã‚³ãƒãƒ³ãƒ‰

ãªã©ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚’è¡Œãˆã‚‹ã€‚
(ã§ã‚‚å®Ÿæ¡ˆä»¶ã§ã‚„ã£ãŸã“ã¨ã¯ãªã„)

---

class: center, middle

## Domaã¸ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ãƒˆã™ã‚‹

---

### ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã—ã‚ˆã†

* Domaã¯ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å£ãŒé«˜ããªã„
* PRè‡ªä½“ã‚‚ã‚³ãƒŸãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ—¥æœ¬èªã§OK
* ä½œè€…ã®[@nakamura_to](https://twitter.com/nakamura_to)ã•ã‚“ãŒã‚ã£ã¡ã‚ƒå„ªã—ã„(PRã®ç›¸è«‡ã‚‚æ°—è»½ã«ä¹—ã£ã¦ãã‚Œã‚‹)
* ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®typoä¿®æ­£ãŒæ°—æ¥½ã‹ã¤å¿…ãšãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã®ã§æœ€åˆã®PRã«ã¯è‰¯ã•ãã†

---

### ã‚ã£ã¡ã‚ƒæ°—ãŒæ¥½

![doma-practice-08](assets/doma-practice-08.png)

â€»PRã®ã‚¿ã‚¤ãƒˆãƒ«ã¯ã‚‚ã†å°‘ã—ã¡ã‚ƒã‚“ã¨æ›¸ãã¾ã—ã‚‡ã†

---

### ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ¼ã«åå‰ã‚’é€£ã­ã‚ˆã†

å¥½ããªOSSã«è²¢çŒ®ã§ãã‚‹ã¨å¬‰ã—ã„ã€‚

![doma-practice-07](assets/doma-practice-07.png)

---

## å‚è€ƒ

* [Doma](http://doma.readthedocs.org/)
* [EntityListenerã‚’DIã‚³ãƒ³ãƒ†ãƒŠã§ç®¡ç†ã™ã‚‹](http://backpaper0.github.io/2015/03/28/doma_listener_from_config.html)
* [å‰æ–¹ä¸€è‡´ã®æ¤œç´¢æ¡ä»¶ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ©ã‚¹](http://backpaper0.github.io/2014/11/01/prefix_domain.html)
* [ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦Spring Batchã§ä½¿ã†](https://github.com/backpaper0/spring-batch-item-stream-reader-doma-sample)
* [SpringBoot + Domaã§è¤‡æ•°ã®`DataSource`ã‚’æ‰±ã†](https://github.com/backpaper0/spring-boot-doma-multi-config-sample)
* [Domaã§immutableãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½¿ã†](https://github.com/backpaper0/doma-immutable-entity-sample)
* [Spring Boot + Doma2ã‚’ä½¿ãŠã† - BLOG.IK.AM](https://blog.ik.am/entries/371)
* [Doma+Springã®é€£æºã‚µãƒ³ãƒ—ãƒ« - BLOG.IK.AM](https://blog.ik.am/entries/191)
* [IntelliJ IDEAã®Domaã‚µãƒãƒ¼ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³](https://github.com/siosio/DomaSupport)

---

## ã“ã®è³‡æ–™ã«ã¤ã„ã¦

* Author: [@backpaper0](https://github.com/backpaper0)
* License:  [The MIT License](https://opensource.org/licenses/MIT)

    </textarea>
    <script src="assets/remark-0.13.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
